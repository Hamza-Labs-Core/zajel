name: PR Pipeline - E2E Tests

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.27.1'
  NODE_VERSION: '20'
  # Pre-release version format: v0.0.0-pr.<PR_NUMBER>.<BUILD_NUMBER>
  VERSION: "0.0.0-pr.${{ github.event.pull_request.number || 0 }}.${{ github.run_number }}"

jobs:
  # ============================================
  # PHASE 1: Unit Tests & Static Analysis
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.VERSION }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Analyze code
        working-directory: packages/app
        run: flutter analyze --no-fatal-infos

      - name: Run unit tests
        working-directory: packages/app
        run: flutter test test/

  server-tests:
    name: Server Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Test server-vps
        working-directory: packages/server-vps
        run: |
          npm ci
          npm test -- --run

      - name: Test server (CF)
        working-directory: packages/server
        run: |
          npm ci
          npm test -- --run

  # ============================================
  # PHASE 2: Tag Pre-release
  # ============================================
  tag-prerelease:
    name: Tag Pre-release
    needs: [unit-tests, server-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create pre-release tag
        id: tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git identity for tagging
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="v${{ env.VERSION }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Delete existing tag if present (for re-runs)
          git push origin :refs/tags/$TAG 2>/dev/null || true

          # Create and push tag
          git tag -a $TAG -m "Pre-release for PR #${{ github.event.pull_request.number || 'manual' }}"
          git push origin $TAG

          echo "Created tag: $TAG"

  # ============================================
  # PHASE 3: Deploy to Cloudflare Workers
  # ============================================
  deploy-cf-signaling:
    name: Deploy CF Signaling
    needs: tag-prerelease
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - uses: actions/checkout@v4

      - name: Deploy signaling server
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/server
          command: deploy --env qa

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10

          # Health check
          for i in {1..5}; do
            if curl -sf "${{ vars.CF_SIGNALING_QA_URL }}/health"; then
              echo "Signaling server healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Warning: Health check failed, continuing anyway"

  deploy-cf-admin:
    name: Deploy CF Admin
    needs: tag-prerelease
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - uses: actions/checkout@v4

      - name: Deploy admin dashboard
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/admin-cf
          command: deploy -c wrangler.jsonc --env qa
        env:
          APP_VERSION: ${{ env.VERSION }}

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10

          for i in {1..5}; do
            RESPONSE=$(curl -sf "${{ vars.CF_ADMIN_QA_URL }}/health" || echo '{}')
            if echo "$RESPONSE" | grep -q "healthy"; then
              echo "Admin server healthy: $RESPONSE"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Warning: Health check failed, continuing anyway"

  # ============================================
  # PHASE 4: Deploy to QA VPS Server
  # ============================================
  deploy-vps:
    name: Deploy QA VPS
    needs: tag-prerelease
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/server-vps/package-lock.json

      - name: Build server
        working-directory: packages/server-vps
        run: |
          npm ci
          npm run build

      - name: Acquire deployment lock
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            LOCK_FILE="/tmp/zajel-deploy.lock"

            # Check for test lock (wait up to 5 minutes)
            for i in {1..30}; do
              if [ ! -f "/tmp/zajel-e2e.lock" ]; then
                break
              fi
              echo "Waiting for E2E tests to complete... ($i/30)"
              sleep 10
            done

            # Create deployment lock
            echo "PR-${{ github.event.pull_request.number }}-${{ github.run_id }}" > $LOCK_FILE

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "packages/server-vps/dist/*,packages/server-vps/package*.json,packages/server-vps/migrations/*"
          target: "/opt/zajel/server-vps-qa"
          strip_components: 2

      - name: Start server
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_VERSION: ${{ env.VERSION }}
        with:
          host: ${{ secrets.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            cd /opt/zajel/server-vps-qa

            # Install dependencies
            npm ci --omit=dev

            # Create QA startup script
            PUBLIC_IP=$(curl -sf http://checkip.amazonaws.com || curl -sf http://ifconfig.me || echo "localhost")
            cat > start-qa.sh << 'SCRIPT'
            #!/bin/bash
            export ZAJEL_PORT=9001
            export ZAJEL_KEY_PATH=./data-qa/server.key
            export ZAJEL_DB_PATH=./data-qa/zajel.db
            export ZAJEL_PUBLIC_ENDPOINT=ws://${PUBLIC_IP}:9001
            export ZAJEL_REGION=qa
            export ZAJEL_BOOTSTRAP_URL=${{ vars.CF_SIGNALING_QA_URL || 'https://zajel-signaling-qa.mahmoud-s-darwish.workers.dev' }}
            export NODE_ENV=qa
            export APP_VERSION=${{ env.VERSION }}
            cd /opt/zajel/server-vps-qa
            exec node dist/index.js
            SCRIPT
            sed -i "s/\${PUBLIC_IP}/$PUBLIC_IP/g" start-qa.sh
            chmod +x start-qa.sh

            mkdir -p data-qa

            # Stop existing QA server
            pm2 delete zajel-server-qa 2>/dev/null || true

            # Start QA server
            pm2 start start-qa.sh --name zajel-server-qa --interpreter bash
            pm2 save

            # Health check
            sleep 5
            for i in {1..6}; do
              if curl -sf http://localhost:9001/health | grep -q "healthy"; then
                echo "Server healthy"
                exit 0
              fi
              echo "Waiting for server... ($i/6)"
              sleep 5
            done

            echo "Health check failed"
            pm2 logs zajel-server-qa --lines 50 --nostream
            exit 1

      - name: Release deployment lock
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            rm -f /tmp/zajel-deploy.lock

  # ============================================
  # PHASE 5: Build APK for E2E Testing
  # ============================================
  build-apk:
    name: Build QA APK
    needs: tag-prerelease
    runs-on: ubuntu-latest
    outputs:
      apk-path: ${{ steps.build.outputs.apk-path }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Build APK with QA config
        id: build
        working-directory: packages/app
        run: |
          flutter build apk --debug \
            --dart-define=ENV=qa \
            --dart-define=VERSION=${{ env.VERSION }} \
            --dart-define=BOOTSTRAP_URL=${{ vars.CF_SIGNALING_QA_URL || 'https://zajel-signaling-qa.mahmoud-s-darwish.workers.dev' }} \
            --dart-define=SIGNALING_URL=${{ vars.VPS_QA_WS_URL || '' }}

          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
          echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT

          # Verify APK exists
          ls -la $APK_PATH

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: qa-apk
          path: packages/app/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 1

  # ============================================
  # PHASE 6: Deploy APK to Emulators & Run E2E
  # ============================================
  e2e-tests:
    name: E2E Tests
    needs: [deploy-cf-signaling, deploy-cf-admin, deploy-vps, build-apk]
    if: ${{ !inputs.skip_e2e }}
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: qa-apk
          path: ./apk

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: e2e-tests/requirements.txt

      - name: Install E2E dependencies
        run: |
          pip install -r e2e-tests/requirements.txt

      - name: Setup SSH tunnels to Appium servers
        env:
          APPIUM_SERVERS: ${{ secrets.APPIUM_SERVERS }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          # Parse comma-separated server list
          IFS=',' read -ra SERVERS <<< "$APPIUM_SERVERS"

          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Disable host key checking for CI
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          echo "UserKnownHostsFile /dev/null" >> ~/.ssh/config

          PORT_BASE=4723
          SERVER_COUNT=0

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | tr -d ' ')
            LOCAL_PORT=$((PORT_BASE + SERVER_COUNT))

            echo "Creating tunnel to $SERVER (local port $LOCAL_PORT)"

            # Create SSH tunnel (Appium default port 4723)
            ssh -f -N -L ${LOCAL_PORT}:localhost:4723 \
              -p ${VPS_PORT} \
              ${VPS_USER}@${SERVER}

            SERVER_COUNT=$((SERVER_COUNT + 1))
          done

          echo "APPIUM_SERVER_COUNT=$SERVER_COUNT" >> $GITHUB_ENV
          echo "Created $SERVER_COUNT SSH tunnels"

          # Verify tunnels
          sleep 2
          for i in $(seq 0 $((SERVER_COUNT - 1))); do
            PORT=$((PORT_BASE + i))
            curl -sf http://localhost:$PORT/status && echo "Appium $i OK" || echo "Appium $i not responding"
          done

      - name: Acquire E2E test lock
        env:
          APPIUM_SERVERS: ${{ secrets.APPIUM_SERVERS }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          IFS=',' read -ra SERVERS <<< "$APPIUM_SERVERS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | tr -d ' ')

            # Wait for deployment lock to clear
            ssh -p ${VPS_PORT} ${VPS_USER}@${SERVER} '
              for i in {1..30}; do
                if [ ! -f "/tmp/zajel-deploy.lock" ]; then
                  break
                fi
                echo "Waiting for deployment to complete... ($i/30)"
                sleep 10
              done

              # Create E2E lock
              echo "E2E-${{ github.run_id }}" > /tmp/zajel-e2e.lock
            '
          done

      - name: Deploy APK to emulators
        env:
          APPIUM_SERVERS: ${{ secrets.APPIUM_SERVERS }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          IFS=',' read -ra SERVERS <<< "$APPIUM_SERVERS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | tr -d ' ')

            echo "Deploying APK to $SERVER"

            # Copy APK to server
            scp -P ${VPS_PORT} ./apk/app-debug.apk ${VPS_USER}@${SERVER}:/tmp/zajel-qa.apk

            # Install on emulator
            ssh -p ${VPS_PORT} ${VPS_USER}@${SERVER} '
              # Find running emulator
              EMULATOR=$(adb devices | grep emulator | head -1 | cut -f1)

              if [ -z "$EMULATOR" ]; then
                echo "No emulator found, starting one..."
                emulator -avd test_device -no-window -no-audio &
                sleep 30
                EMULATOR=$(adb devices | grep emulator | head -1 | cut -f1)
              fi

              if [ -z "$EMULATOR" ]; then
                echo "ERROR: No emulator available"
                exit 1
              fi

              echo "Installing APK on $EMULATOR"
              adb -s $EMULATOR install -r /tmp/zajel-qa.apk

              echo "APK installed successfully"
            '
          done

      - name: Run E2E tests
        env:
          APK_PATH: /tmp/zajel-qa.apk
          APPIUM_SERVER_COUNT: ${{ env.APPIUM_SERVER_COUNT }}
        run: |
          cd e2e-tests

          # Run smoke tests first
          pytest tests/test_pairing.py -v -m smoke --timeout=300 || exit 1

          # Run full test suite
          pytest tests/ -v --timeout=600 \
            --ignore=tests/test_reconnection.py \
            -x  # Stop on first failure

      - name: Release E2E test lock
        if: always()
        env:
          APPIUM_SERVERS: ${{ secrets.APPIUM_SERVERS }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          IFS=',' read -ra SERVERS <<< "$APPIUM_SERVERS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | tr -d ' ')
            ssh -p ${VPS_PORT} ${VPS_USER}@${SERVER} 'rm -f /tmp/zajel-e2e.lock' || true
          done

      - name: Collect test artifacts
        if: failure()
        run: |
          mkdir -p test-artifacts
          cp -r e2e-tests/reports/* test-artifacts/ 2>/dev/null || true

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: test-artifacts/
          retention-days: 7

  # ============================================
  # PHASE 7: Cleanup Pre-release Tag on Failure
  # ============================================
  cleanup:
    name: Cleanup on Failure
    needs: [tag-prerelease, e2e-tests]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete pre-release tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ env.VERSION }}"
          git push origin :refs/tags/$TAG 2>/dev/null || true
          echo "Deleted tag: $TAG"

  # ============================================
  # Summary
  # ============================================
  summary:
    name: Pipeline Summary
    needs: [unit-tests, server-tests, tag-prerelease, deploy-cf-signaling, deploy-cf-admin, deploy-vps, build-apk, e2e-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## PR Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server Tests | ${{ needs.server-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release Tag | ${{ needs.tag-prerelease.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CF Signaling | ${{ needs.deploy-cf-signaling.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CF Admin | ${{ needs.deploy-cf-admin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VPS Servers | ${{ needs.deploy-vps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build APK | ${{ needs.build-apk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
