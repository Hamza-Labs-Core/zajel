name: PR Pipeline - E2E Tests

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.27.1'
  NODE_VERSION: '20'
  # Version will be computed from latest release in determine-version job

jobs:
  # ============================================
  # Determine version from latest release
  # ============================================
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get latest release and compute version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest release tag
          LATEST=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName' 2>/dev/null || echo "v0.0.0")
          echo "Latest release: $LATEST"

          # Strip 'v' prefix and extract major.minor.patch
          LATEST_VERSION="${LATEST#v}"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          # Increment patch for pre-release
          NEXT_PATCH=$((PATCH + 1))

          # Create pre-release version: X.Y.Z-pr.PR_NUMBER.BUILD_NUMBER
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_NUM="${PR_NUM:-0}"
          VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-pr.${PR_NUM}.${{ github.run_number }}"

          echo "Computed version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # PHASE 1: Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Analyze code
        working-directory: packages/app
        run: flutter analyze --no-fatal-infos

      - name: Run unit tests
        working-directory: packages/app
        run: flutter test test/

  server-tests:
    name: Server Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Test server-vps
        working-directory: packages/server-vps
        run: |
          npm ci
          npm test -- --run

      - name: Test server (CF)
        working-directory: packages/server
        run: |
          npm ci
          npm test -- --run

  phase-1-tests:
    name: "✓ Phase 1: Tests"
    needs: [unit-tests, server-tests]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All tests passed"

  # ============================================
  # PHASE 2: Tag Pre-release
  # ============================================
  tag-prerelease:
    name: Tag Pre-release
    needs: [determine-version, phase-1-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.determine-version.outputs.version }}
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create pre-release tag
        id: tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git identity for tagging
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="v${{ env.VERSION }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Delete existing tag if present (for re-runs)
          git push origin :refs/tags/$TAG 2>/dev/null || true

          # Create and push tag
          git tag -a $TAG -m "Pre-release for PR #${{ github.event.pull_request.number || 'manual' }}"
          git push origin $TAG

          echo "Created tag: $TAG"

  phase-2-tag:
    name: "✓ Phase 2: Tag"
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    steps:
      - run: echo "Tag created - ${{ needs.tag-prerelease.outputs.tag }}"

  # ============================================
  # PHASE 3: Builds & Server Deployments (parallel)
  # ============================================
  build-android:
    name: Build Android
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Build APK with QA config
        working-directory: packages/app
        run: |
          flutter build apk --release \
            --dart-define=ENV=qa \
            --dart-define=VERSION=${{ env.VERSION }} \
            --dart-define=BOOTSTRAP_URL=${{ vars.QA_BOOTSTRAP_URL }} \
            --dart-define=SIGNALING_URL=${{ vars.VPS_QA_WS_URL || '' }}

          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/zajel-${{ env.VERSION }}-android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: packages/app/build/app/outputs/flutter-apk/zajel-${{ env.VERSION }}-android.apk
          retention-days: 1

  # ----------------------------------------
  # Build iOS
  # ----------------------------------------
  build-ios:
    name: Build iOS
    needs: [tag-prerelease]
    runs-on: macos-latest
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Build iOS (no codesign)
        working-directory: packages/app
        run: |
          flutter build ios --release --no-codesign \
            --dart-define=ENV=qa \
            --dart-define=VERSION=${{ env.VERSION }} \
            --dart-define=BOOTSTRAP_URL=${{ vars.QA_BOOTSTRAP_URL }} \
            --dart-define=SIGNALING_URL=${{ vars.VPS_QA_WS_URL || '' }}

          # Create IPA-like archive for distribution
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r zajel-${{ env.VERSION }}-ios.ipa Payload
          mv zajel-${{ env.VERSION }}-ios.ipa ../../../

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: packages/app/zajel-${{ env.VERSION }}-ios.ipa
          retention-days: 1

  # ----------------------------------------
  # Build Linux
  # ----------------------------------------
  build-linux:
    name: Build Linux
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libjsoncpp-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Enable Linux desktop
        working-directory: packages/app
        run: |
          flutter config --enable-linux-desktop
          flutter create --platforms=linux . || true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Build Linux
        working-directory: packages/app
        run: |
          flutter build linux --release \
            --dart-define=ENV=qa \
            --dart-define=VERSION=${{ env.VERSION }} \
            --dart-define=BOOTSTRAP_URL=${{ vars.QA_BOOTSTRAP_URL }} \
            --dart-define=SIGNALING_URL=${{ vars.VPS_QA_WS_URL || '' }}

          cd build/linux/x64/release/bundle
          tar -czvf zajel-${{ env.VERSION }}-linux-x64.tar.gz *
          mv zajel-${{ env.VERSION }}-linux-x64.tar.gz ../../../../../

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: packages/app/zajel-${{ env.VERSION }}-linux-x64.tar.gz
          retention-days: 1

  # ----------------------------------------
  # Build macOS
  # ----------------------------------------
  build-macos:
    name: Build macOS
    needs: [tag-prerelease]
    runs-on: macos-latest
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Enable macOS desktop and prepare
        working-directory: packages/app
        run: |
          flutter config --enable-macos-desktop
          flutter create --platforms=macos . || true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Build macOS
        working-directory: packages/app
        run: |
          flutter build macos --release \
            --dart-define=ENV=qa \
            --dart-define=VERSION=${{ env.VERSION }} \
            --dart-define=BOOTSTRAP_URL=${{ vars.QA_BOOTSTRAP_URL }} \
            --dart-define=SIGNALING_URL=${{ vars.VPS_QA_WS_URL || '' }}

          cd build/macos/Build/Products/Release
          zip -r zajel-${{ env.VERSION }}-macos.zip zajel.app
          mv zajel-${{ env.VERSION }}-macos.zip ../../../../../

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: packages/app/zajel-${{ env.VERSION }}-macos.zip
          retention-days: 1

  # ----------------------------------------
  # Build Web
  # ----------------------------------------
  build-web:
    name: Build Web
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        working-directory: packages/app
        run: flutter pub get

      - name: Build Web
        working-directory: packages/app
        run: |
          flutter build web --release \
            --dart-define=ENV=qa \
            --dart-define=VERSION=${{ env.VERSION }} \
            --dart-define=BOOTSTRAP_URL=${{ vars.QA_BOOTSTRAP_URL }} \
            --dart-define=SIGNALING_URL=${{ vars.VPS_QA_WS_URL || '' }}

          cd build/web
          zip -r zajel-${{ env.VERSION }}-web.zip *
          mv zajel-${{ env.VERSION }}-web.zip ../../

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: packages/app/zajel-${{ env.VERSION }}-web.zip
          retention-days: 1

  # Phase 3 gate - after all builds and deployments
  phase-3-build-deploy:
    name: "✓ Phase 3: Build & Deploy"
    # Note: deploy-vps removed from dependencies - VPS deployment failures should not block pipeline
    # E2E tests now run on GitHub Actions runners with hardware-accelerated emulators
    needs: [build-android, build-ios, build-linux, build-macos, build-web, deploy-cf-signaling, deploy-cf-admin, deploy-cf-website]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All builds and deployments completed"

  # ============================================
  # PHASE 4: Release & APK Deployment
  # ============================================
  create-prerelease:
    name: Create GitHub Pre-release
    needs: [phase-3-build-deploy, tag-prerelease]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate changelog
        id: changelog
        run: |
          # Get the base branch (usually main)
          BASE_BRANCH="${{ github.base_ref || 'main' }}"

          # Generate changelog from commits in this PR
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits between base and head
          git log origin/${BASE_BRANCH}..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md || echo "- Initial pre-release" >> CHANGELOG.md

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Build Info" >> CHANGELOG.md
          echo "- **Version:** ${{ env.VERSION }}" >> CHANGELOG.md
          echo "- **PR:** #${{ github.event.pull_request.number }}" >> CHANGELOG.md
          echo "- **Branch:** ${{ github.head_ref }}" >> CHANGELOG.md
          echo "- **Commit:** ${{ github.sha }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Downloads" >> CHANGELOG.md
          echo "| Platform | File |" >> CHANGELOG.md
          echo "|----------|------|" >> CHANGELOG.md
          echo "| Android | zajel-${{ env.VERSION }}-android.apk |" >> CHANGELOG.md
          echo "| iOS | zajel-${{ env.VERSION }}-ios.ipa |" >> CHANGELOG.md
          echo "| Linux | zajel-${{ env.VERSION }}-linux-x64.tar.gz |" >> CHANGELOG.md
          echo "| macOS | zajel-${{ env.VERSION }}-macos.zip |" >> CHANGELOG.md
          echo "| Web | zajel-${{ env.VERSION }}-web.zip |" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "> ⚠️ **Pre-release:** This is a test build for PR #${{ github.event.pull_request.number }}. Not for production use." >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Move all artifacts to release-assets with proper names
          find ./artifacts -type f \( -name "*.apk" -o -name "*.ipa" -o -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} ./release-assets/ \;

          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag-prerelease.outputs.tag }}
          name: "Pre-release ${{ needs.tag-prerelease.outputs.tag }}"
          body_path: CHANGELOG.md
          prerelease: true
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # PHASE 3: Deploy to QA Environment (parallel with builds)
  # ============================================
  deploy-cf-signaling:
    name: Deploy CF Signaling
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    environment: qa
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy signaling server
        id: deploy-signaling
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/server
          command: deploy --env qa

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10

          # Get URL from deployment output
          DEPLOY_URL="${{ steps.deploy-signaling.outputs.deployment-url }}"
          if [ -z "$DEPLOY_URL" ]; then
            echo "No deployment URL found, skipping health check"
            exit 0
          fi

          echo "Checking health at: $DEPLOY_URL"
          for i in {1..5}; do
            if curl -sf "$DEPLOY_URL/health"; then
              echo "Signaling server healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Warning: Health check failed, continuing anyway"

  deploy-cf-admin:
    name: Deploy CF Admin
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    environment: qa
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy admin dashboard
        id: deploy-admin
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/admin-cf
          command: deploy -c wrangler.jsonc --env qa
        env:
          APP_VERSION: ${{ env.VERSION }}

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10

          DEPLOY_URL="${{ steps.deploy-admin.outputs.deployment-url }}"
          if [ -z "$DEPLOY_URL" ]; then
            echo "No deployment URL found, skipping health check"
            exit 0
          fi

          echo "Checking health at: $DEPLOY_URL"
          for i in {1..5}; do
            RESPONSE=$(curl -sf "$DEPLOY_URL/health" || echo '{}')
            if echo "$RESPONSE" | grep -q "healthy"; then
              echo "Admin server healthy: $RESPONSE"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Warning: Health check failed, continuing anyway"

  deploy-cf-website:
    name: Deploy CF Website
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    environment: qa
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: packages/website
        run: npm ci

      - name: Build website
        working-directory: packages/website
        run: npm run build

      - name: Deploy website
        id: deploy-website
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/website
          command: deploy -c wrangler.jsonc --env qa

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10

          DEPLOY_URL="${{ steps.deploy-website.outputs.deployment-url }}"
          if [ -z "$DEPLOY_URL" ]; then
            echo "No deployment URL found, skipping health check"
            exit 0
          fi

          echo "Checking deployment at: $DEPLOY_URL"
          for i in {1..5}; do
            if curl -sf "$DEPLOY_URL" > /dev/null; then
              echo "Website deployed successfully"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Warning: Health check failed, continuing anyway"

  deploy-vps:
    name: Deploy QA VPS
    needs: [tag-prerelease]
    runs-on: ubuntu-latest
    environment: qa
    env:
      VERSION: ${{ needs.tag-prerelease.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/server-vps/package-lock.json

      - name: Build server
        working-directory: packages/server-vps
        run: |
          npm ci
          npm run build

      - name: Acquire deployment lock
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            LOCK_FILE="/tmp/zajel-deploy.lock"

            # Check for test lock (wait up to 5 minutes)
            for i in {1..30}; do
              if [ ! -f "/tmp/zajel-e2e.lock" ]; then
                break
              fi
              echo "Waiting for E2E tests to complete... ($i/30)"
              sleep 10
            done

            # Create deployment lock
            echo "PR-${{ github.event.pull_request.number }}-${{ github.run_id }}" > $LOCK_FILE

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "packages/server-vps/dist/*,packages/server-vps/package*.json,packages/server-vps/migrations/*"
          target: "/opt/zajel/server-vps-qa"
          strip_components: 2

      - name: Start server
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_VERSION: ${{ needs.tag-prerelease.outputs.version }}
          BOOTSTRAP_URL: ${{ vars.QA_BOOTSTRAP_URL }}
        with:
          host: ${{ vars.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: APP_VERSION,BOOTSTRAP_URL
          script: |
            set -e

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install pm2 if not present
            if ! command -v pm2 &> /dev/null; then
              echo "Installing pm2..."
              sudo npm install -g pm2
            fi

            # Create deployment directory
            sudo mkdir -p /opt/zajel/server-vps-qa
            sudo chown -R $USER:$USER /opt/zajel

            cd /opt/zajel/server-vps-qa

            # Install dependencies
            npm ci --omit=dev

            # Create QA startup script with env vars
            PUBLIC_IP=$(curl -sf http://checkip.amazonaws.com || curl -sf http://ifconfig.me || echo "localhost")
            cat > start-qa.sh << EOF
            #!/bin/bash
            export ZAJEL_PORT=9001
            export ZAJEL_KEY_PATH=./data-qa/server.key
            export ZAJEL_DB_PATH=./data-qa/zajel.db
            export ZAJEL_PUBLIC_ENDPOINT=ws://${PUBLIC_IP}:9001
            export ZAJEL_REGION=qa
            export ZAJEL_BOOTSTRAP_URL=${BOOTSTRAP_URL}
            export NODE_ENV=qa
            export APP_VERSION=${APP_VERSION}
            cd /opt/zajel/server-vps-qa
            exec node dist/index.js
            EOF
            chmod +x start-qa.sh

            mkdir -p data-qa

            # Stop existing QA server
            pm2 delete zajel-server-qa 2>/dev/null || true

            # Start QA server
            pm2 start start-qa.sh --name zajel-server-qa --interpreter bash
            pm2 save

            # Health check
            sleep 5
            for i in {1..6}; do
              if curl -sf http://localhost:9001/health | grep -q "healthy"; then
                echo "Server healthy"
                exit 0
              fi
              echo "Waiting for server... ($i/6)"
              sleep 5
            done

            echo "Health check failed"
            pm2 logs zajel-server-qa --lines 50 --nostream
            exit 1

      - name: Release deployment lock
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.QA_VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            rm -f /tmp/zajel-deploy.lock

  # ============================================
  # PHASE 5: E2E Tests (Ubuntu with KVM-accelerated emulator)
  # ============================================
  e2e-tests:
    name: E2E Tests
    needs: [build-android, deploy-cf-signaling, deploy-cf-admin]
    # Run on PR events always, and on workflow_dispatch unless skip_e2e is true
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.skip_e2e != true) }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-build
          path: ./apk

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Enable KVM for hardware acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Appium
        run: |
          npm install -g appium
          appium driver install uiautomator2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: e2e-tests/requirements.txt

      - name: Install E2E dependencies
        run: pip install -r e2e-tests/requirements.txt

      - name: Find APK path
        id: apk
        run: |
          # Use absolute path since the emulator runner uses a different working directory
          APK_FILE=$(find ${{ github.workspace }}/apk -name "*.apk" | head -1)
          echo "APK_PATH=$APK_FILE" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_FILE"

      - name: Create and start emulators
        timeout-minutes: 10
        env:
          ANDROID_AVD_HOME: ${{ github.workspace }}/.android/avd
        run: |
          # Add Android SDK tools to PATH
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH"

          # Create AVD home directory
          mkdir -p "$ANDROID_AVD_HOME"

          echo "Installing system image..."
          yes | sdkmanager "system-images;android-31;google_apis;x86_64" --channel=0

          echo "Creating AVDs..."
          echo "no" | avdmanager create avd -n test-avd-1 -k "system-images;android-31;google_apis;x86_64" --force
          echo "no" | avdmanager create avd -n test-avd-2 -k "system-images;android-31;google_apis;x86_64" --force

          echo "Listing AVDs..."
          avdmanager list avd

          echo "Restarting adb server..."
          adb kill-server || true
          adb start-server

          echo "Starting emulator 1 (port 5554)..."
          nohup $ANDROID_HOME/emulator/emulator -avd test-avd-1 -port 5554 -no-snapshot-load -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -wipe-data 2>&1 &
          EMULATOR1_PID=$!
          echo "EMULATOR1_PID=$EMULATOR1_PID" >> $GITHUB_ENV

          echo "Starting emulator 2 (port 5556)..."
          nohup $ANDROID_HOME/emulator/emulator -avd test-avd-2 -port 5556 -no-snapshot-load -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -wipe-data 2>&1 &
          EMULATOR2_PID=$!
          echo "EMULATOR2_PID=$EMULATOR2_PID" >> $GITHUB_ENV

          echo "Waiting for emulators to boot..."
          sleep 5
          adb wait-for-device -s emulator-5554
          adb wait-for-device -s emulator-5556
          timeout 180 adb -s emulator-5554 shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 2; done'
          echo "Emulator 1 booted"
          timeout 180 adb -s emulator-5556 shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 2; done'
          echo "Emulator 2 booted"
          adb devices

      - name: Run E2E tests
        timeout-minutes: 10
        env:
          APK_PATH: ${{ steps.apk.outputs.APK_PATH }}
          ANDROID_AVD_HOME: ${{ github.workspace }}/.android/avd
          APPIUM_SERVER_COUNT: "2"
        working-directory: ${{ github.workspace }}/e2e-tests
        run: |
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH"

          # Disable animations on both emulators
          for EMU in emulator-5554 emulator-5556; do
            adb -s $EMU shell settings put global window_animation_scale 0
            adb -s $EMU shell settings put global transition_animation_scale 0
            adb -s $EMU shell settings put global animator_duration_scale 0
          done

          # Install APK on both emulators
          adb -s emulator-5554 install "$APK_PATH"
          adb -s emulator-5556 install "$APK_PATH"

          # Start 2 Appium servers, each bound to a specific emulator
          appium --address 127.0.0.1 --port 4723 --relaxed-security --default-capabilities '{"appium:udid":"emulator-5554"}' &
          APPIUM1_PID=$!
          appium --address 127.0.0.1 --port 4724 --relaxed-security --default-capabilities '{"appium:udid":"emulator-5556"}' &
          APPIUM2_PID=$!
          sleep 10
          curl -sf http://localhost:4723/status && echo "✓ Appium 1 (emulator-5554) is ready"
          curl -sf http://localhost:4724/status && echo "✓ Appium 2 (emulator-5556) is ready"

          # Run E2E tests
          pytest tests/ -v --timeout=300 -x
          TEST_RESULT=$?

          # Cleanup Appium
          kill $APPIUM1_PID $APPIUM2_PID 2>/dev/null || true

          exit $TEST_RESULT

      - name: Stop emulators
        if: always()
        timeout-minutes: 1
        run: |
          export PATH="$ANDROID_HOME/platform-tools:$PATH"
          adb -s emulator-5554 emu kill 2>/dev/null || true
          adb -s emulator-5556 emu kill 2>/dev/null || true
          kill $EMULATOR1_PID $EMULATOR2_PID 2>/dev/null || true
          pkill -9 qemu-system-x86_64 2>/dev/null || true

      - name: Collect logs on failure
        if: failure()
        timeout-minutes: 1
        run: |
          export PATH="$ANDROID_HOME/platform-tools:$PATH"
          mkdir -p test-artifacts
          timeout 10 adb -s emulator-5554 logcat -d > test-artifacts/logcat-emu1.txt 2>&1 || true
          timeout 10 adb -s emulator-5556 logcat -d > test-artifacts/logcat-emu2.txt 2>&1 || true
          cp /tmp/appium*.log test-artifacts/ 2>/dev/null || true

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: test-artifacts/
          retention-days: 1

  phase-5-e2e:
    name: "✓ Phase 5: E2E Tests"
    needs: [e2e-tests]
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.skip_e2e != true) }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "E2E tests passed"

  # ============================================
  # Cleanup Pre-release Tag on Failure
  # ============================================
  cleanup:
    name: Cleanup on Failure
    needs: [tag-prerelease, e2e-tests]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete pre-release tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ env.VERSION }}"
          git push origin :refs/tags/$TAG 2>/dev/null || true
          echo "Deleted tag: $TAG"

  # ============================================
  # Summary
  # ============================================
  summary:
    name: Pipeline Summary
    needs: [phase-1-tests, phase-2-tag, phase-3-build-deploy, phase-5-e2e]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## PR Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Phase 1: Tests | ${{ needs.phase-1-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Phase 2: Tag | ${{ needs.phase-2-tag.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Phase 3: Build & Deploy | ${{ needs.phase-3-build-deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Phase 5: E2E Tests | ${{ needs.phase-5-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
