name: Release

on:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # Generate changelog from commits since last tag
  changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since last tag
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create changelog
          {
            echo 'changelog<<EOF'
            echo "## What's Changed"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${GITHUB_REF_NAME}"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  # Build Android APK and AAB
  build-android:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

  # Build iOS
  build-ios:
    runs-on: macos-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r ../../../zajel-ios.ipa Payload

      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: zajel-ios.ipa

  # Build macOS
  build-macos:
    runs-on: macos-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build macOS
        run: flutter build macos --release

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "Zajel" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            "zajel-macos.dmg" \
            "build/macos/Build/Products/Release/zajel.app" || true
          # Fallback to zip if dmg creation fails
          if [ ! -f "zajel-macos.dmg" ]; then
            cd build/macos/Build/Products/Release
            zip -r ../../../../../zajel-macos.zip zajel.app
          fi

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            zajel-macos.dmg
            zajel-macos.zip
          if-no-files-found: ignore

  # Build Windows
  build-windows:
    runs-on: windows-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create zip
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath zajel-windows.zip

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: zajel-windows.zip

  # Build Linux
  build-linux:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libsecret-1-dev

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create tarball
        run: |
          cd build/linux/x64/release
          tar -czvf ../../../../zajel-linux.tar.gz bundle

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: zajel-linux.tar.gz

  # Create GitHub Release with all artifacts
  release:
    needs: [changelog, build-android, build-ios, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Rename artifacts
        env:
          VERSION: ${{ needs.changelog.outputs.version }}
        run: |
          mkdir release-files
          # Android
          cp artifacts/android-apk/app-release.apk "release-files/zajel-${VERSION}-android.apk"
          cp artifacts/android-aab/app-release.aab "release-files/zajel-${VERSION}-android.aab"
          # iOS
          cp artifacts/ios-build/zajel-ios.ipa "release-files/zajel-${VERSION}-ios.ipa" || true
          # macOS
          cp artifacts/macos-build/zajel-macos.dmg "release-files/zajel-${VERSION}-macos.dmg" 2>/dev/null || \
          cp artifacts/macos-build/zajel-macos.zip "release-files/zajel-${VERSION}-macos.zip" 2>/dev/null || true
          # Windows
          cp artifacts/windows-build/zajel-windows.zip "release-files/zajel-${VERSION}-windows.zip"
          # Linux
          cp artifacts/linux-build/zajel-linux.tar.gz "release-files/zajel-${VERSION}-linux.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Zajel v${{ needs.changelog.outputs.version }}
          body: ${{ needs.changelog.outputs.changelog }}
          files: release-files/*
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
